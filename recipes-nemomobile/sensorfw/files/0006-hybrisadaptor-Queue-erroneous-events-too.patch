From f0784287165372b435b7496cba03de60d4038a59 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Darrel=20Gri=C3=ABt?= <dgriet@gmail.com>
Date: Sun, 15 Feb 2026 12:54:38 +0100
Subject: [PATCH] hybrisadaptor: Queue erroneous events too
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Previously events were queued regardless of whether they're erroneous.
This was changed with the move to a dedicated worker thread (https://github.com/sailfishos/sensorfw/commit/6dae56c1e45dd0a3a36094b5296baa83a072de35).

This causes for tilt-to-wake to not work on dory as it results in the
following logs:
```
Mar 06 14:52:32 dory kernel: lis3dsh_acc 4-001e: DEVICE IN TILT
Mar 06 14:52:32 dory sensorfwd[406]: "incorrect event version (version=13, expected=104"
Mar 06 14:52:37 dory sensorfwd[406]: "incorrect event version (version=1695154228, expected=104"
Mar 06 14:52:37 dory kernel: lis3dsh_acc 4-001e: DEVICE IN TILT
Mar 06 14:52:40 dory kernel: lis3dsh_acc 4-001e: DEVICE IN TILT
Mar 06 14:52:40 dory sensorfwd[406]: "incorrect event version (version=1173, expected=104"
Mar 06 14:52:45 dory sensorfwd[406]: "incorrect event version (version=52, expected=104"
Mar 06 14:52:45 dory kernel: lis3dsh_acc 4-001e: DEVICE IN TILT
```

This rectifies this issue.

Upstream-Status: Inappropriate

Signed-off-by: Darrel GriÃ«t <dgriet@gmail.com>
---
 core/hybrisadaptor.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/core/hybrisadaptor.cpp b/core/hybrisadaptor.cpp
index b2779d4..4716214 100644
--- a/core/hybrisadaptor.cpp
+++ b/core/hybrisadaptor.cpp
@@ -1390,7 +1390,7 @@ int HybrisManager::queueEvents(const sensors_event_t *buffer, int numEvents)
         ObtainTemporaryWakeLock();
 
     /* Forward via pipe for processing in main threah */
-    if (!errorInInput && numEvents > 0 && m_eventPipeWriteFd != -1) {
+    if (numEvents > 0 && m_eventPipeWriteFd != -1) {
         if (::write(m_eventPipeWriteFd, buffer, numEvents * sizeof *buffer) == -1) {
             sensordLogW("event pipe write failure: %s", strerror(errno));
             errorInInput = true;
-- 
2.53.0

