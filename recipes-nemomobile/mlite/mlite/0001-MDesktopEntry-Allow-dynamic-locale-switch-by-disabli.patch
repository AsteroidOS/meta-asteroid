From fb289c677c0a1d44b0750371dcbbbc676875a19e Mon Sep 17 00:00:00 2001
From: Florent Revest <revestflo@gmail.com>
Date: Thu, 2 Oct 2025 18:17:14 +0200
Subject: [PATCH] MDesktopEntry: Allow dynamic locale switch by disabling some
 of the asumptions made when using glib's conf files functions

Upstream-Status: Inappropriate

---
 src/mdesktopentry.cpp | 8 +++-----
 1 file changed, 3 insertions(+), 5 deletions(-)

diff --git a/src/mdesktopentry.cpp b/src/mdesktopentry.cpp
index a17389d..7d9dcb3 100644
--- a/src/mdesktopentry.cpp
+++ b/src/mdesktopentry.cpp
@@ -73,7 +73,7 @@ bool GKeyFileWrapper::load(QIODevice &device)
     QByteArray contents = device.readAll();
 
     GError *err = NULL;
-    if (!g_key_file_load_from_data(m_key_file, contents.constData(), contents.size(), G_KEY_FILE_NONE, &err)) {
+    if (!g_key_file_load_from_data(m_key_file, contents.constData(), contents.size(), G_KEY_FILE_KEEP_TRANSLATIONS, &err)) {
         qWarning() << "Could not load .desktop file:" << QString::fromUtf8(err->message);
         g_clear_error(&err);
         return false;
@@ -136,9 +136,10 @@ QString GKeyFileWrapper::localizedValue(const QString &section, const QString &k
 
     QByteArray section_utf8 = section.toUtf8();
     QByteArray key_utf8 = key.toUtf8();
+    QByteArray locale_utf8 = qgetenv("LANG");
 
     GError *err = NULL;
-    gchar *value = g_key_file_get_locale_string(m_key_file, section_utf8.constData(), key_utf8.constData(), NULL, &err);
+    gchar *value = g_key_file_get_locale_string(m_key_file, section_utf8.constData(), key_utf8.constData(), locale_utf8.constData(), &err);
     if (!value) {
         qWarning() << "Could not read value:" << QString::fromUtf8(err->message);
         g_clear_error(&err);
@@ -483,11 +484,8 @@ QString MDesktopEntry::name() const
 {
     Q_D(const MDesktopEntry);
 
-    if (!d->translatedName.isEmpty())
-        return d->translatedName;
 
     QString name = localizedValue(DesktopEntrySection, NameKey);
-    d->translatedName = name;
     return name;
 }
 
